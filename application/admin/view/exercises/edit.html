<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>题库管理系统 | 编辑习题</title>
        {include file="header"/}
        <link href="__ROOT__/public/static/css/bootstrapValidator.min.css" rel="stylesheet" type="text/css" />
    </head>
    <body class="skin-blue">
        <!-- header logo: style can be found in header.less -->
        {include file="nav"/}
        <div class="wrapper row-offcanvas row-offcanvas-left">
            <!-- Left side column. contains the logo and sidebar -->
            {include file="menu"/}
            <!-- Right side column. Contains the navbar and content of the page -->
            <aside class="right-side">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>
                        习题管理
                        <small>编辑习题</small>
                    </h1>
                    <ol class="breadcrumb">
                        <li><a href="#"><i class="fa fa-dashboard"></i> 首页</a></li>
                        <li><a href="#">习题</a></li>
                        <li class="active">编辑习题</li>
                    </ol>
                </section>
                <!-- Main content -->
                <section class="content">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="box box-danger">
                                <div class="box-header">
                                    <h3 class="box-title"></h3>
                                </div>
                                <div class="box-body">
                                    <form method="POST" name="form" id="form" action="{:url('admin/exercises/doedit')}" enctype="multipart/form-data">
                                        <div class="form-group">
                                            <label>所属科目(必选)</label>
                                            <div class="input-group">
                                                <select class="form-control" name="subject_id">
                                                    <option value="">请选择科目</option>
                                                    {volist name="subjects" id="vo"}
                                                    <option value="{$vo.subject_id}" {if $vo.subject_id == $question.subject_id} selected{/if}>{$vo.subject_name}</option>
                                                    {/volist}
                                                </select>
                                            </div><!-- /.input group -->
                                        </div><!-- /.form group -->
                                        <div class="form-group">
                                            <label>所属章节(必填)</label>
                                            <div class="input-group">
                                                <select class="form-control" name="chapter_id">
                                                </select>
                                            </div><!-- /.input group -->
                                        </div><!-- /.form group -->
                                        <div class="form-group">
                                            <label>题型(必填)</label>
                                            <div class="input-group">
                                                <select class="form-control" name="question_type" id="type-s">
                                                    <option value="1" {if $question['question_type'] == 1 } selected="selected"{/if}>单选</option>
                                                    <option value="2" {if $question['question_type'] == 2 } selected="selected"{/if}>多选</option>
                                                    <option value="10" {if $question['question_type'] == 10 } selected="selected"{/if}>填空</option>
                                                </select>
                                            </div><!-- /.input group -->
                                        </div><!-- /.form group -->
                                        <div class="form-group">
                                            <label>题目内容(必填)</label>
                                            <div class="input-group">
                                                <textarea class="form-control" rows="15" placeholder="输入题目内容 ..." name="question_content" id="content">{$question.content}</textarea>
                                            </div><!-- /.input group -->
                                        </div><!-- /.form group -->
                                        <div class="form-group">
                                            <label>录入选项(必填)</label><br/>
                                            <div class="input-group" id="option-group">
                                                {if $question['question_type'] == 1 || $question['question_type'] == 2}
                                                {volist name="question['answer']" id="vo"}
                                                {if $question['question_type'] == 1}
                                                <input type="radio" class="minimal-red" name="right_answer[]" value="{$key+65|chr}" {if in_array(chr($key+65),$answers)} checked {/if}><label>{$key+65|chr}</label>
                                                <textarea name="option[]" style="margin-bottom:15px;" id="option-{$key}"><?php echo explode('.',$vo)[1];?></textarea>
                                                {else if $question['question_type'] == 2}
                                                <input type="checkbox" class="minimal-red" name="right_answer[]" value="{$key+65|chr}" {if in_array(chr($key+65),$answers)} checked {/if}><label>{$key+65|chr}</label><textarea name="option[]" style="margin-bottom:15px;" id="option-{$key}"><?php echo explode('.',$vo)[1];?></textarea>
                                                <hr/>
                                                {/if}
                                                {/volist}
                                                {else if $question['question_type'] == 10 }
                                                <a href="javascript:;" onClick="addFill();" class="btn btn-flat btn-primary">添加答案</a><br/><br/>
                                                {volist name="question['answer']" id="vo" key="k"}
                                                第{$k}空：<input type="text" class="form-control fill-input" name="correct_answer[]" value="{$vo}">
                                                {/volist}
                                                {/if}
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label>题目解析(必填)</label>
                                            <div class="input-group">
                                                <textarea class="form-control" rows="3" placeholder="输入题目解析 ..." name="analytical">{$question.analytical}</textarea>
                                            </div><!-- /.input group -->
                                        </div><!-- /.form group -->
                                        <input type="submit" class="btn btn-flat btn-primary" value="保存">
                                        <input type="hidden" name="sid" value="{$question.exercises_id}">
                                    </form>
                                </div><!-- /.box-body -->
                            </div><!-- /.box -->
                        </div><!-- /.col (left) -->
                    </div><!-- /.row -->
                </section><!-- /.content -->
            </aside><!-- /.right-side -->
        </div><!-- ./wrapper -->
        {include file="footer"/}
        <script src="__ROOT__/public/static/js/bootstrapValidator.min.js" type="text/javascript"></script>
        <script>
            var addFill = function() {
                var index = $('.fill-input').length;
                $('#option-o-group').append('第'+(index+1)+'空：<input type="text" class="form-control fill-input" name="correct_answer[]">');
            }
            $(document).ready(function() {
                CKEDITOR.replace('content');
                CKEDITOR.replace('analytical');

                $('#form').bootstrapValidator({
                    fields: {
                        subject_name: {
                            validators: {
                                notEmpty: {
                                    message: '科目名称不能为空'
                                },
                                stringLength: {
                                    min: 0,
                                    max: 255,
                                    message: '科目名称过长'
                                }
                            }
                        },
                    	subject_description: {
                            validators: {
                                stringLength: {
                                    min: 0,
                                    max: 255,
                                    message: '描述文字过长'
                                }
                            }
                        }
                    }
                });

                function createOption() {
                    var type = $('#type-s').val();
                    var index = $('#option-o-group input:text').size();
                    var code = String.fromCharCode(index+65);
                    var value = index == 0 ? '正确' : '错误';
                    switch (parseInt(type)) {
                        case 1:
                            for(var i=0;i<4;i++) {
                                $('#option-group input').attr('type','radio');
                                $('#option-group input').attr('name','right_answer[]');
                                CKEDITOR.replace("option-"+i);
                            }
                            break;
                        case 2:
                            for(var i=0;i<4;i++) {
                                $('#option-group input').attr('type','checkbox');
                                $('#option-group input').attr('name','right_answer[]');
                                CKEDITOR.replace("option-"+i);
                            }
                            break;
                    }
                }
                createOption();

                $('#type-s').change(function() {
                    createOption();
                });

                
                var subject = $('select[name="subject_id"]').val();
                $.get('{:url("admin/chapter/getChapters")}?sid='+subject,function(json){
                    var obj = jQuery.parseJSON(json);
                    var html = '';
                    $.each(obj,function(index,item){
                        if (parseInt(item.chapter_id) === parseInt('{$question.chapter_id}')) {
                            html += '<option value="'+item.chapter_id+'" selected="selected">'+item.chapter_name+'</option>';
                        } else {
                            html += '<option value="'+item.chapter_id+'">'+item.chapter_name+'</option>';
                        }
                    });
                    $('select[name="chapter_id"]').html(html);
                });
            });

            $('select[name="subject_id"]').change(function(){
                $.get('{:url("admin/chapter/getChapters")}?sid='+$(this).val(),function(json){
                    var obj = jQuery.parseJSON(json);
                    var html = '';
                    $.each(obj,function(index,item){
                        html += '<option value="'+item.chapter_id+'">'+item.chapter_name+'</option>';
                    });
                    $('select[name="chapter_id"]').html(html);
                });
            });
        </script>
        <script type="text/javascript" src="__ROOT__/public/static/ckeditor/ckeditor.js"></script>
        <script type="text/javascript" src="__ROOT__/public/static/js/custom-menu.js"></script>

    </body>
</html>
